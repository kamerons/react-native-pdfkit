# PDFKit React Native Implementation Summary

## Overview

This document summarizes the implementation of PDF generation support in React Native using pdfkit. The current implementation uses patches and adapters to make pdfkit work in a React Native environment, but this approach has created unsustainable technical debt. This document is intended to guide the implementation of a proper fork of pdfkit that natively supports React Native.

## Problem Statement

PDFKit is a Node.js library that relies on:

1. **Node.js `fs` module** - for reading font files and ICC profiles from the filesystem
2. **Node.js `zlib` module** - for compressing PDF streams
3. **Node.js `stream` module** - for handling data streams
4. **`__dirname` global** - for constructing paths to font files
5. **`Buffer` global** - for binary data handling

React Native does not provide these Node.js APIs, requiring polyfills and adapters.

## Current Implementation Components

### 1. Polyfills (`index.js`)

**Location:** `index.js`

**Purpose:** Provide Node.js globals that pdfkit expects

**Implementation:**

- **`__dirname` polyfill:** Set to `/node_modules/pdfkit` as a dummy path. The fsAdapter extracts actual filenames from paths like `__dirname + '/data/Courier.afm'`.
- **`Buffer` polyfill:** Uses the `buffer` npm package to provide Node.js-compatible Buffer implementation.

```javascript
if (typeof global.__dirname === 'undefined') {
  global.__dirname = '/node_modules/pdfkit';
}

if (typeof global.Buffer === 'undefined') {
  global.Buffer = require('buffer').Buffer;
}
```

### 2. File System Adapter (`src/utils/adapters/fsAdapter.js`)

**Purpose:** Provides a Node.js `fs`-compatible API using `react-native-fs`

**Key Features:**

- **Font file handling:** Loads font files (`.afm`) from generated JavaScript modules instead of filesystem
- **ICC profile handling:** Loads ICC profile (`sRGB_IEC61966_2_1.icc`) from generated JavaScript module
- **Synchronous file reading:** Uses busy-wait pattern to wrap async `react-native-fs` calls
- **Path extraction:** Extracts filenames from paths like `__dirname + '/data/Courier.afm'`

**Font Files Supported:**

- Courier.afm, Courier-Bold.afm, Courier-Oblique.afm, Courier-BoldOblique.afm
- Helvetica.afm, Helvetica-Bold.afm, Helvetica-Oblique.afm, Helvetica-BoldOblique.afm
- Times-Roman.afm, Times-Bold.afm, Times-Italic.afm, Times-BoldItalic.afm
- Symbol.afm, ZapfDingbats.afm

**Implementation Details:**

- Font files are loaded from generated modules at `src/utils/adapters/fonts/*.afm.js`
- ICC profile is loaded from `src/utils/adapters/fonts/sRGB_IEC61966_2_1.icc.js`
- Uses a font cache to avoid reloading fonts
- For other files (e.g., images), uses `react-native-fs` with busy-wait pattern
- Supports both `readFileSync()` and `readFile()` (async) APIs

**Busy-Wait Pattern:**
The adapter uses a busy-wait loop with 10ms delays to convert async `react-native-fs` calls into synchronous operations that pdfkit expects. This is necessary because pdfkit's API is synchronous.

### 3. Zlib Adapter (`src/utils/adapters/zlibAdapter.js`)

**Purpose:** Provides a Node.js `zlib`-compatible API using `@klarna/react-native-zlib`

**Key Features:**

- **Synchronous deflate:** Uses busy-wait pattern to wrap async `react-native-zlib` calls
- **Async deflate/inflate:** Provides callback-based async APIs
- **Data conversion:** Converts between Buffer/Uint8Array and array format required by `react-native-zlib`

**Implementation Details:**

- `deflateSync()`: Uses busy-wait pattern with periodic checks (every 100 iterations) to allow event loop processing
- `deflate()`: Async callback-based wrapper
- `inflate()`: Async callback-based wrapper
- Converts input from Buffer/Uint8Array to array for `react-native-zlib`
- Converts output from array back to Buffer

**Busy-Wait Pattern:**
Similar to fsAdapter, uses a busy-wait loop but with optimizations:

- Checks every 100 iterations to reduce CPU usage
- Uses minimal delays (1ms) to allow event loop processing
- Has timeout protection (5 seconds) and iteration limit (10,000)

### 4. Font Module Generation (`scripts/generateFontModules.ts`)

**Purpose:** Converts font files (`.afm`) and ICC profile (`.icc`) into JavaScript modules that can be bundled by Metro

**Input:** Font files from `assets/pdfkit/` directory

**Output:** JavaScript modules in `src/utils/adapters/fonts/` directory

**Process:**

1. Reads font files as UTF-8 strings
2. Escapes special characters (backslashes, quotes, newlines, etc.)
3. Generates JavaScript modules that export the content as strings
4. For ICC profile, reads as binary, converts to base64, exports as Buffer

**Generated Module Format:**

```javascript
/* eslint-disable */
/**
 * Auto-generated font module for Courier.afm
 * Generated by scripts/generateFontModules.ts
 * DO NOT EDIT - This file is auto-generated
 */

module.exports = 'StartFontMetrics 4.1\r\n...';
module.exports.default = module.exports;
```

**ICC Module Format:**

```javascript
const base64Content = '...';
module.exports = Buffer.from(base64Content, 'base64');
module.exports.default = module.exports;
```

### 5. Metro Configuration (`metro.config.js`)

**Changes:**

- Added `watchFolders` to include `src/` directory
- Added TypeScript file extensions to `sourceExts`
- Configured transformer to handle TypeScript files in node_modules

**Purpose:** Ensures Metro bundler can resolve and transpile adapter files when referenced from patched node_modules

### 6. Metro Transformer (`metro-transformer-afm.js`)

**Purpose:** Handles `.afm` and `.icc` files if they're directly imported (though this is not currently used - fonts are loaded via generated modules)

**Implementation:** Transforms `.afm` and `.icc` files into JavaScript modules that export their content as strings

### 7. Patches Applied

#### 7.1 PDFKit Patch (`patches/pdfkit+0.17.2.patch`)

**Size:** ~990 lines

**Key Changes:**

1. **Replaced `fs` imports:** All `require('fs')` and `import fs from 'fs'` replaced with `require('../adapters/fsAdapter')` or `import fs from '../adapters/fsAdapter'`
2. **Replaced `zlib` imports:** All `require('zlib')` and `import zlib from 'zlib'` replaced with `require('../adapters/zlibAdapter')` or `import zlib from '../adapters/zlibAdapter'`
3. **Replaced `stream` imports:** Changed from `require('stream')` to `require('readable-stream')` for React Native compatibility
4. **Added adapter files:** Created `adapters/fsAdapter.js` and `adapters/zlibAdapter.js` in pdfkit's node_modules directory
5. **Added font modules:** Created `adapters/fonts/*.afm.js` modules for all 14 font files
6. **Added ICC module:** Created `adapters/fonts/sRGB_IEC61966_2_1.icc.js`
7. **Made `finalize()` async:** Changed `PDFReference.finalize()` to async and updated callers to handle async zlib operations
8. **Updated image compression:** Changed synchronous `zlib.deflateSync()` calls to async `zlib.deflate()` with Promise wrappers

**Files Modified:**

- `js/pdfkit.js` (CommonJS build)
- `js/pdfkit.es.js` (ES module build)
- `js/pdfkit.es5.js` (ES5 build)
- `js/pdfkit.esnext.js` (ESNext build)
- `lib/font/data.js` (font data loading)
- `lib/image/png.js` (PNG image handling)

#### 7.2 JPEG-EXIF Patch (`patches/jpeg-exif+1.1.4.patch`)

**Purpose:** Makes jpeg-exif work with React Native for reading EXIF data from images

**Changes:**

1. Created `adapters/fsAdapter.js` - simplified version without font handling
2. Replaced `require('fs')` with `require('../adapters/fsAdapter')` in:
   - `lib/index.js`
   - `src/index.js`

**Note:** Uses the same busy-wait pattern as the main fsAdapter

#### 7.3 PNG-JS Patch (`patches/png-js+1.0.0.patch`)

**Purpose:** Makes png-js work with React Native for PNG image decoding

**Changes:**

1. Created `adapters/fsAdapter.js` - simplified version without font handling
2. Created `adapters/zlibAdapter.js` - simplified version with only `deflateSync()` and `inflate()`
3. Replaced `require('fs')` and `require('zlib')` with adapter requires in `png-node.js`

#### 7.4 React Native Zlib Patch (`patches/@klarna+react-native-zlib+1.0.1.patch`)

**Purpose:** Fixes AndroidX compatibility issue

**Changes:**

- Replaced `android.support.annotation.NonNull` with `androidx.annotation.NonNull` in Java source

## How Everything Works Together

1. **Application Startup (`index.js`):**

   - Polyfills `__dirname` and `Buffer` globals
   - These are available before pdfkit is imported

2. **Font Module Generation (Build Time):**

   - `scripts/generateFontModules.ts` runs (likely via postinstall script)
   - Converts font files to JavaScript modules
   - Modules are bundled by Metro

3. **PDF Generation (Runtime):**
   - pdfkit imports are patched to use adapters
   - When pdfkit needs a font file:
     - Calls `fs.readFileSync(__dirname + '/data/Courier.afm')`
     - fsAdapter extracts filename "Courier.afm"
     - Loads from generated module `src/utils/adapters/fonts/Courier.afm.js`
     - Returns font content as string/Buffer
   - When pdfkit needs to compress data:
     - Calls `zlib.deflateSync(data)` or `zlib.deflate(data, callback)`
     - zlibAdapter converts to array format
     - Calls `@klarna/react-native-zlib`
     - Converts result back to Buffer
   - For images (JPEG/PNG):
     - jpeg-exif and png-js use their own adapter patches
     - Read files via react-native-fs

## Current Issues

1. **Empty PDFs:** PDFs are generated but contain no text. This suggests font loading may not be working correctly, or there's an issue with how text is being rendered.

   **Potential Causes:**

   - Font files may not be loading correctly from generated modules
   - PDFKit may be using default fonts (Helvetica) but fonts aren't being embedded
   - The async-to-sync conversion in adapters may be causing timing issues
   - Font cache may not be working correctly
   - Path extraction from `__dirname + '/data/font.afm'` may be failing

   **Debugging Steps:**

   - Verify font modules are being generated correctly
   - Check if `fsAdapter.readFileSync()` is being called for fonts
   - Verify font cache is populated
   - Check if PDFKit is throwing errors during font loading
   - Test with explicit font selection: `doc.font('Helvetica')` before rendering text

2. **Technical Debt:**

   - Large patches (990+ lines for pdfkit alone)
   - Busy-wait patterns are inefficient and can cause performance issues
   - Multiple copies of similar adapter code across patches
   - Hard to maintain and update dependencies
   - Font modules must be regenerated if fonts change

3. **Synchronous API Limitations:**
   - Busy-wait patterns block the JavaScript thread
   - Can cause UI freezes on slower devices
   - Not ideal for React Native's async nature

## Recommendations for PDFKit Fork

### 1. Native React Native Support

Create a fork of pdfkit with built-in React Native support:

**File System:**

- Replace all `fs` usage with a configurable adapter interface
- Provide React Native adapter that uses `react-native-fs` natively (async)
- Make font loading async-friendly
- Bundle fonts as JavaScript modules or use asset system

**Zlib:**

- Replace all `zlib` usage with a configurable adapter interface
- Provide React Native adapter using `@klarna/react-native-zlib`
- Make compression operations async where possible
- Keep sync API for backward compatibility but implement efficiently

**Streams:**

- Use `readable-stream` instead of Node.js `stream` module
- Ensure compatibility with React Native's stream polyfills

**Font Loading:**

- Bundle fonts as part of the library (as JavaScript modules or base64)
- Provide API to load custom fonts
- Cache loaded fonts in memory
- Support both sync and async font loading

### 2. Architecture Changes

**Adapter Pattern:**

```javascript
// In pdfkit fork
class PDFKit {
  constructor(options = {}) {
    this.fs = options.fs || require('fs'); // Default to Node.js fs
    this.zlib = options.zlib || require('zlib'); // Default to Node.js zlib
    // ... rest of initialization
  }
}
```

**React Native Usage:**

```javascript
import PDFKit from 'pdfkit-react-native';
import { createFSAdapter } from 'pdfkit-react-native/adapters/fs';
import { createZlibAdapter } from 'pdfkit-react-native/adapters/zlib';

const fsAdapter = createFSAdapter();
const zlibAdapter = createZlibAdapter();

const doc = new PDFKit({
  fs: fsAdapter,
  zlib: zlibAdapter,
});
```

### 3. Font Handling

**Option A: Bundled Fonts (Recommended)**

- Include fonts as JavaScript modules in the package
- No need for external font files
- Works out of the box in React Native

**Option B: Asset System**

- Use React Native's asset system
- Load fonts from bundle at runtime
- More flexible but requires asset configuration

**Option C: Hybrid**

- Bundle standard fonts (Courier, Helvetica, Times, Symbol, ZapfDingbats)
- Allow loading custom fonts via API

### 4. Async API Support

While maintaining backward compatibility, add async alternatives:

```javascript
// Sync (current)
doc.text('Hello', 100, 100);

// Async (new)
await doc.textAsync('Hello', 100, 100);
// or
doc.text('Hello', 100, 100, () => {
  /* callback */
});
```

### 5. Performance Optimizations

- Remove busy-wait patterns
- Use proper async/await or callbacks
- Batch font loading operations
- Cache compressed data where possible
- Use Web Workers for heavy operations (if available in React Native)

### 6. Build System

- Use Metro-compatible build output
- Ensure all dependencies are React Native compatible
- Provide TypeScript definitions
- Include font modules in package

### 7. Testing

- Test on both iOS and Android
- Test with various font combinations
- Test with images (JPEG, PNG)
- Performance testing on low-end devices
- Memory leak testing

## Migration Path

1. **Create fork:** Fork pdfkit repository
2. **Implement adapter pattern:** Add configurable fs/zlib adapters
3. **Bundle fonts:** Include fonts as JavaScript modules
4. **Update build:** Ensure React Native compatibility
5. **Test thoroughly:** Verify all functionality works
6. **Publish package:** Publish as `pdfkit-react-native` or similar
7. **Update application:** Replace patched pdfkit with fork
8. **Remove patches:** Remove all patches and adapter code from application
9. **Remove polyfills:** May still need Buffer polyfill, but can remove \_\_dirname workaround

## Files to Reference

- `index.js` - Polyfills
- `src/utils/adapters/fsAdapter.js` - File system adapter
- `src/utils/adapters/zlibAdapter.js` - Zlib adapter
- `scripts/generateFontModules.ts` - Font module generator
- `patches/pdfkit+0.17.2.patch` - Main pdfkit patch (reference for all changes)
- `patches/jpeg-exif+1.1.4.patch` - JPEG-EXIF patch
- `patches/png-js+1.0.0.patch` - PNG-JS patch
- `patches/@klarna+react-native-zlib+1.0.1.patch` - Zlib library patch
- `metro.config.js` - Metro bundler configuration
- `metro-transformer-afm.js` - Metro transformer (optional reference)

## Conclusion

The current implementation works but is unsustainable. A proper fork of pdfkit with native React Native support would:

1. Eliminate the need for patches
2. Provide better performance (no busy-wait)
3. Be easier to maintain and update
4. Have a cleaner API
5. Support both Node.js and React Native from a single codebase

The adapter pattern is the key - making fs and zlib configurable allows the same codebase to work in both environments while providing optimized implementations for each.
